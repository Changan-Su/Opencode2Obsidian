# 01-插件初始化

## 背景/目标

建立Obsidian插件的基础架构,实现插件的生命周期管理、设置系统、命令注册等核心功能。

**参考实现**: opencode-obsidian-main/src/main.ts

**目标**:
- 实现完整的Obsidian插件生命周期(onload/onunload)
- 支持插件设置的加载和保存
- 注册Ribbon图标、命令和快捷键
- 管理ProcessManager和View的生命周期
- 提供自动启动选项

## 方案/计划

### 核心模块
1. **OpenCodePlugin类** (main.ts)
   - 继承Obsidian Plugin基类
   - 管理settings、processManager、view
   - 实现生命周期钩子

2. **类型定义** (types.ts)
   - OpenCodeSettings接口
   - DEFAULT_SETTINGS常量
   - OPENCODE_VIEW_TYPE常量

3. **图标注册** (icons.ts)
   - 自定义OpenCode图标
   - SVG图标定义

### 实现步骤
1. ✅ 创建项目结构和配置文件
   - package.json
   - tsconfig.json
   - esbuild.config.mjs
   - manifest.json

2. [ ] 实现types.ts
   - OpenCodeSettings接口
   - 默认设置值
   - 常量定义

3. [ ] 实现icons.ts
   - registerOpenCodeIcons函数
   - SVG图标定义

4. [ ] 实现main.ts核心逻辑
   - onload(): 初始化插件
   - onunload(): 清理资源
   - loadSettings/saveSettings
   - 命令和快捷键注册
   - Ribbon图标添加
   - 视图管理方法

5. [ ] 配置构建系统
   - esbuild配置
   - 开发和生产构建脚本

## 实现要点

### Settings结构
```typescript
interface OpenCodeSettings {
  opencodePath: string;           // OpenCode CLI路径
  port: number;                   // 服务端口
  hostname: string;               // 主机名
  autoStart: boolean;             // 自动启动
  startupTimeout: number;         // 启动超时时间
  projectDirectory: string;       // 项目目录(vault路径)
  defaultViewLocation: "main" | "right"; // 视图位置
}
```

### 命令注册
- `toggle-opencode-view`: 切换OpenCode面板 (Ctrl/Cmd+Shift+O)
- `start-opencode-server`: 手动启动服务
- `stop-opencode-server`: 手动停止服务

### 生命周期管理
- **onload**: 
  - 注册图标
  - 加载设置
  - 初始化ProcessManager
  - 注册视图
  - 添加Ribbon和命令
  - 可选自动启动
- **onunload**: 
  - 停止服务
  - 分离所有OpenCode视图

### 项目目录获取
```typescript
getProjectDirectory(): string {
  if (this.settings.projectDirectory) {
    return this.settings.projectDirectory;
  }
  const adapter = this.app.vault.adapter as any;
  return adapter.basePath || "";
}
```

## 问题与解决

### 问题1: TypeScript严格模式配置
- **问题**: 需要严格的类型检查
- **解决**: 
  - tsconfig.json启用strictNullChecks
  - 使用strict模式
  - 所有公共方法显式返回类型

### 问题2: Obsidian API外部化
- **问题**: obsidian包不应打包到插件中
- **解决**: esbuild配置external: ['obsidian', 'electron', '@codemirror/*']

### 问题3: 开发环境热重载
- **问题**: 开发时需要快速迭代
- **解决**: esbuild watch模式 + Obsidian开发者模式

## 复盘

**待实施后填写**

## 后续

1. 完成基础代码实现
2. 集成ProcessManager模块
3. 集成OpenCodeView模块
4. 测试插件生命周期
5. 优化错误处理

## 复盘

**实施完成**: 2026-01-18

### 完成情况
- ✅ types.ts: 完整实现了OpenCodeSettings接口和默认配置
- ✅ icons.ts: 使用简洁的终端风格SVG图标
- ✅ main.ts: 实现了完整的插件生命周期管理
  - 支持3个命令(toggle/start/stop)
  - 快捷键 Ctrl/Cmd+Shift+O
  - 自动启动选项
  - 完整的状态订阅机制

### 实施亮点
1. **状态订阅模式**: 使用回调数组实现了灵活的状态变更通知
2. **项目目录获取**: 自动从vault获取basePath,支持自定义覆盖
3. **视图位置灵活性**: 支持右侧边栏或主面板两种位置
4. **Toggle逻辑**: 智能判断侧边栏vs主面板的不同toggle行为

### 遇到的问题
无重大问题,参考实现非常清晰

### 改进点
- 添加了更详细的TypeScript注释
- 改名为OpenCode2ObsidianPlugin更清晰

## 后续

1. ✅ 完成基础代码实现
2. ✅ 集成ProcessManager模块
3. ✅ 集成OpenCodeView模块
4. [ ] 测试插件生命周期
5. [ ] 优化错误处理
