# 04-跨平台支持

## 背景/目标

确保插件在Windows、macOS和Linux系统上都能正常工作,特别是优化Windows系统的支持。

**参考roadmap**: v0.2.0目标

**目标**:
- Windows路径处理优化
- 进程管理跨平台兼容
- 可执行文件查找逻辑
- 不同OS的默认设置

## 方案/计划

### 跨平台问题点
1. **路径分隔符**: Windows使用反斜杠,Unix使用正斜杠
2. **可执行文件扩展名**: Windows需要.exe或.cmd
3. **进程信号**: Windows不完全支持POSIX信号
4. **环境变量**: PATH分隔符不同(Windows用;,Unix用:)
5. **文件系统**: 大小写敏感性差异

### 实现步骤
1. [ ] 路径处理优化
   - 使用path模块标准化路径
   - 支持Windows UNC路径

2. [ ] 可执行文件查找
   - 检测opencode/opencode.exe/opencode.cmd
   - 在PATH中搜索

3. [ ] 进程终止优化
   - Windows使用taskkill
   - Unix使用SIGTERM/SIGKILL

4. [ ] 测试不同系统
   - Windows 10/11
   - macOS
   - Linux

## 实现要点

### 路径标准化
```typescript
import { normalize, resolve } from "path";

getProjectDirectory(): string {
  let dir = this.settings.projectDirectory;
  if (!dir) {
    const adapter = this.app.vault.adapter as any;
    dir = adapter.basePath || "";
  }
  // 标准化路径分隔符
  return normalize(dir);
}
```

### 可执行文件查找
```typescript
import { platform } from "os";

function findOpenCodeExecutable(userPath: string): string {
  // 如果用户提供了完整路径
  if (userPath.includes('/') || userPath.includes('\\')) {
    return userPath;
  }
  
  // Windows需要添加.exe或.cmd
  if (platform() === "win32") {
    // 检查是否已有扩展名
    if (!userPath.endsWith('.exe') && !userPath.endsWith('.cmd')) {
      // 先尝试.exe,再尝试.cmd,最后尝试无扩展名
      return userPath; // spawn会自动查找
    }
  }
  
  return userPath;
}
```

### Windows进程终止
```typescript
import { exec } from "child_process";
import { platform } from "os";

stop(): void {
  if (!this.process || !this.process.pid) {
    this.setState("stopped");
    return;
  }

  const pid = this.process.pid;
  this.setState("stopped");
  this.process = null;

  if (platform() === "win32") {
    // Windows使用taskkill
    exec(`taskkill /pid ${pid} /T /F`, (error) => {
      if (error) {
        console.error("[OpenCode] Failed to kill process:", error);
      }
    });
  } else {
    // Unix使用信号
    try {
      process.kill(pid, "SIGTERM");
      setTimeout(() => {
        try {
          process.kill(pid, 0); // 检查进程是否存在
          process.kill(pid, "SIGKILL"); // 仍存在则强制kill
        } catch {
          // 进程已终止
        }
      }, 2000);
    } catch (error) {
      console.error("[OpenCode] Failed to kill process:", error);
    }
  }
}
```

### spawn配置
```typescript
import { platform } from "os";

const spawnOptions = {
  cwd: this.projectDirectory,
  env: { ...process.env },
  stdio: ["ignore", "pipe", "pipe"],
  detached: false,
  // Windows特定选项
  ...(platform() === "win32" && {
    windowsHide: true,  // 隐藏控制台窗口
  })
};
```

### 默认设置按平台
```typescript
import { platform } from "os";

export const DEFAULT_SETTINGS: OpenCodeSettings = {
  opencodePath: platform() === "win32" ? "opencode.exe" : "opencode",
  port: 14096,
  hostname: "127.0.0.1",
  autoStart: false,
  startupTimeout: 30000,
  projectDirectory: "",
  defaultViewLocation: "right",
};
```

## 问题与解决

### 问题1: Windows路径中的空格
- **问题**: 路径如"C:\Program Files\..."会导致问题
- **解决**: 
  - spawn使用数组参数自动处理
  - 不要手动拼接命令字符串
  - 使用normalize标准化路径

### 问题2: Windows进程不响应SIGTERM
- **问题**: Windows不完全支持POSIX信号
- **解决**: 
  - 使用taskkill命令
  - /T参数终止进程树
  - /F参数强制终止

### 问题3: 大小写敏感性
- **问题**: Windows不区分大小写,Unix区分
- **解决**: 
  - 代码中统一使用小写
  - 配置文件名使用小写
  - 避免依赖大小写区分

### 问题4: 行尾符差异
- **问题**: Windows CRLF vs Unix LF
- **解决**: 
  - .gitattributes配置
  - Git autocrlf设置
  - EditorConfig配置

## 复盘

**待实施后填写**

## 后续

1. 在Windows环境测试
2. 在macOS环境测试
3. 在Linux环境测试
4. 添加平台检测和提示
5. 文档中说明各平台要求

