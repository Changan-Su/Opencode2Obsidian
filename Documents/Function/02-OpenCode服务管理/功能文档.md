# 02-OpenCode服务管理

## 背景/目标

管理OpenCode服务的完整生命周期,包括进程启动、停止、健康检查和状态监控。

**参考实现**: opencode-obsidian-main/src/ProcessManager.ts

**目标**:
- 启动和停止OpenCode服务进程
- 监控服务健康状态
- 处理进程异常和错误
- 提供状态变更通知机制
- 支持优雅关闭和强制终止

## 方案/计划

### 核心模块
1. **ProcessManager类**
   - 进程生命周期管理
   - 健康检查机制
   - 状态机管理
   - 错误处理

### 状态定义
```typescript
type ProcessState = "stopped" | "starting" | "running" | "error";
```

### 实现步骤
1. [ ] 实现ProcessManager基础结构
   - 构造函数和成员变量
   - 状态管理方法

2. [ ] 实现start()方法
   - 状态检查
   - 进程spawn
   - 健康检查轮询
   - 超时处理

3. [ ] 实现stop()方法
   - SIGTERM优雅关闭
   - SIGKILL强制终止
   - 超时强制kill

4. [ ] 实现健康检查
   - /global/health端点检测
   - 超时处理
   - 重试机制

5. [ ] 实现状态变更通知
   - 回调机制
   - 状态订阅模式

## 实现要点

### 进程启动流程
```typescript
async start(): Promise<boolean> {
  // 1. 状态检查
  if (running) return true;
  
  // 2. 设置starting状态
  setState("starting");
  
  // 3. 检查服务是否已运行
  if (await checkServerHealth()) {
    setState("running");
    return true;
  }
  
  // 4. spawn进程
  spawn(opencodePath, [
    "serve",
    "--port", port,
    "--hostname", hostname,
    "--cors", "app://obsidian.md"
  ], { cwd: projectDirectory });
  
  // 5. 等待健康检查通过
  if (await waitForServerOrExit(timeout)) {
    setState("running");
    return true;
  }
  
  // 6. 超时处理
  stop();
  setError("Server failed to start");
  return false;
}
```

### 健康检查
```typescript
async checkServerHealth(): Promise<boolean> {
  try {
    const response = await fetch(
      `${getUrl()}/global/health`,
      { signal: AbortSignal.timeout(2000) }
    );
    return response.ok;
  } catch {
    return false;
  }
}
```

### URL生成
```typescript
getUrl(): string {
  const encodedPath = btoa(projectDirectory);
  return `http://${hostname}:${port}/${encodedPath}`;
}
```

### 进程事件处理
- **stdout**: 日志输出到console
- **stderr**: 错误输出到console.error
- **exit**: 处理进程退出
  - 记录退出码
  - 更新状态
  - 清理资源
- **error**: 处理spawn错误
  - ENOENT: 可执行文件不存在
  - 其他错误: 通用错误处理

### 优雅关闭
```typescript
stop(): void {
  // 1. 发送SIGTERM
  process.kill("SIGTERM");
  
  // 2. 2秒后检查
  setTimeout(() => {
    if (process still alive) {
      // 3. 强制SIGKILL
      process.kill("SIGKILL");
    }
  }, 2000);
}
```

## 问题与解决

### 问题1: 进程提前退出
- **问题**: 进程在健康检查完成前退出
- **解决**: 
  - 记录earlyExitCode
  - waitForServerOrExit检测进程状态
  - 提供详细错误信息

### 问题2: 端口已被占用
- **问题**: 端口被其他进程占用
- **解决**: 
  - 先检查健康状态
  - 如果已有服务运行,直接复用
  - 避免重复启动

### 问题3: 路径中包含空格
- **问题**: Windows路径可能包含空格
- **解决**: 
  - spawn使用数组参数(自动处理)
  - 不使用shell模式避免转义问题

### 问题4: 启动超时设置
- **问题**: 不同机器启动速度不同
- **解决**: 
  - 可配置的startupTimeout
  - 默认值适中(建议30秒)
  - 轮询间隔500ms

## 复盘

**待实施后填写**

## 后续

1. 实现ProcessManager完整功能
2. 添加详细日志记录
3. 优化错误处理和用户提示
4. 测试各种异常场景
5. 考虑添加进程监控和自动重启

