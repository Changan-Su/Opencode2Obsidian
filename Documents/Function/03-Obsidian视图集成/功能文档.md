# 03-Obsidian视图集成

## 背景/目标

在Obsidian侧边栏或主面板中创建自定义视图,通过iframe嵌入OpenCode Web UI,并根据服务状态动态渲染UI。

**参考实现**: opencode-obsidian-main/src/OpenCodeView.ts

**目标**:
- 实现自定义ItemView显示OpenCode界面
- 支持多种服务状态的UI展示
- 提供服务控制按钮(启动/停止/重载)
- 实现懒加载和自动启动
- 支持侧边栏和主面板两种位置

## 方案/计划

### 核心模块
1. **OpenCodeView类**
   - 继承ItemView
   - 管理iframe生命周期
   - 订阅ProcessManager状态
   - 渲染不同状态UI

2. **SettingsTab类**
   - 继承PluginSettingTab
   - 提供设置界面
   - 保存配置到插件settings

### 视图状态
- **stopped**: 显示启动按钮
- **starting**: 显示加载动画
- **running**: 显示iframe和控制按钮
- **error**: 显示错误信息和重试按钮

### 实现步骤
1. [ ] 实现OpenCodeView基础结构
   - 继承ItemView
   - 实现基础方法(getViewType/getDisplayText/getIcon)

2. [ ] 实现onOpen生命周期
   - 订阅状态变更
   - 初始渲染
   - 懒启动逻辑

3. [ ] 实现onClose生命周期
   - 取消订阅
   - 清理iframe

4. [ ] 实现状态渲染方法
   - renderStoppedState()
   - renderStartingState()
   - renderRunningState()
   - renderErrorState()

5. [ ] 实现SettingsTab
   - 设置项UI
   - 保存逻辑
   - 验证逻辑

## 实现要点

### OpenCodeView基础结构
```typescript
export class OpenCodeView extends ItemView {
  plugin: OpenCodePlugin;
  private iframeEl: HTMLIFrameElement | null = null;
  private currentState: ProcessState = "stopped";
  private unsubscribeStateChange: (() => void) | null = null;

  constructor(leaf: WorkspaceLeaf, plugin: OpenCodePlugin) {
    super(leaf);
    this.plugin = plugin;
  }

  getViewType(): string {
    return OPENCODE_VIEW_TYPE;
  }

  getDisplayText(): string {
    return "OpenCode";
  }

  getIcon(): string {
    return OPENCODE_ICON_NAME;
  }
}
```

### 状态订阅模式
```typescript
async onOpen(): Promise<void> {
  // 订阅状态变更
  this.unsubscribeStateChange = this.plugin.onProcessStateChange((state) => {
    this.currentState = state;
    this.updateView();
  });

  // 初始渲染
  this.currentState = this.plugin.getProcessState();
  this.updateView();

  // 懒启动
  if (this.currentState === "stopped") {
    this.plugin.startServer();
  }
}

async onClose(): Promise<void> {
  // 取消订阅防止内存泄漏
  if (this.unsubscribeStateChange) {
    this.unsubscribeStateChange();
  }
  
  // 清理iframe
  if (this.iframeEl) {
    this.iframeEl.src = "about:blank";
    this.iframeEl = null;
  }
}
```

### Running状态UI
```typescript
private renderRunningState(): void {
  // Header with controls
  const headerEl = this.contentEl.createDiv({ cls: "opencode-header" });
  
  // Title
  const titleSection = headerEl.createDiv({ cls: "opencode-header-title" });
  setIcon(titleSection.createSpan(), OPENCODE_ICON_NAME);
  titleSection.createSpan({ text: "OpenCode" });
  
  // Actions
  const actionsEl = headerEl.createDiv({ cls: "opencode-header-actions" });
  
  // Reload button
  const reloadButton = actionsEl.createEl("button");
  setIcon(reloadButton, "refresh-cw");
  reloadButton.addEventListener("click", () => this.reloadIframe());
  
  // Stop button
  const stopButton = actionsEl.createEl("button");
  setIcon(stopButton, "square");
  stopButton.addEventListener("click", () => this.plugin.stopServer());
  
  // iframe
  this.iframeEl = this.contentEl.createEl("iframe", {
    cls: "opencode-iframe",
    attr: {
      src: this.plugin.getServerUrl(),
      frameborder: "0",
      allow: "clipboard-read; clipboard-write"
    }
  });
}
```

### iframe重载
```typescript
private reloadIframe(): void {
  if (this.iframeEl) {
    const src = this.iframeEl.src;
    this.iframeEl.src = "about:blank";
    setTimeout(() => {
      if (this.iframeEl) {
        this.iframeEl.src = src;
      }
    }, 100);
  }
}
```

### SettingsTab实现
```typescript
export class OpenCodeSettingTab extends PluginSettingTab {
  display(): void {
    const { containerEl } = this;
    containerEl.empty();
    
    // OpenCode路径
    new Setting(containerEl)
      .setName("OpenCode path")
      .setDesc("Path to OpenCode executable")
      .addText(text => text
        .setPlaceholder("opencode")
        .setValue(this.plugin.settings.opencodePath)
        .onChange(async (value) => {
          this.plugin.settings.opencodePath = value;
          await this.plugin.saveSettings();
        }));
    
    // 端口
    new Setting(containerEl)
      .setName("Port")
      .addText(text => text
        .setValue(String(this.plugin.settings.port))
        .onChange(async (value) => {
          const port = parseInt(value);
          if (!isNaN(port)) {
            this.plugin.settings.port = port;
            await this.plugin.saveSettings();
          }
        }));
    
    // ... 其他设置
  }
}
```

### CSS样式要点
```css
.opencode-container {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.opencode-iframe-container {
  flex: 1;
  position: relative;
}

.opencode-iframe {
  width: 100%;
  height: 100%;
  border: none;
}

.opencode-status-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  gap: 1rem;
}
```

## 问题与解决

### 问题1: iframe跨域问题
- **问题**: Obsidian使用app://协议,需要CORS配置
- **解决**: 
  - OpenCode启动时传递--cors app://obsidian.md
  - iframe allow属性允许clipboard访问

### 问题2: 视图位置切换
- **问题**: 用户希望在侧边栏或主面板打开
- **解决**: 
  - defaultViewLocation设置
  - activateView方法根据设置选择位置
  - 支持动态切换

### 问题3: 内存泄漏
- **问题**: 状态订阅未取消导致内存泄漏
- **解决**: 
  - onClose中取消订阅
  - 返回unsubscribe函数
  - 清理iframe src

### 问题4: 视图toggle逻辑
- **问题**: 侧边栏和主面板toggle行为不同
- **解决**: 
  - 检测视图所在位置
  - 侧边栏: 检查collapsed状态
  - 主面板: 直接detach

## 复盘

**待实施后填写**

## 后续

1. 实现OpenCodeView完整功能
2. 实现SettingsTab
3. 添加样式文件styles.css
4. 测试各种状态切换
5. 优化UI体验和过渡动画

