# 06-AGENTS初始化

## 背景/目标

为新用户自动生成AGENTS.md文件,帮助OpenCode更好地理解vault结构和用户需求。

**参考roadmap**: v0.3.0目标 - "AGENTS.md initialization"

**目标**:
- 检测vault中是否存在AGENTS.md
- 提供AGENTS.md模板
- 根据vault结构生成个性化内容
- 引导用户完善AGENTS.md

## 方案/计划

### 核心功能
1. **检测机制**
   - 首次打开OpenCode视图时检查
   - 在vault根目录查找AGENTS.md

2. **模板生成**
   - 预置通用模板
   - 分析vault结构
   - 生成个性化建议

3. **用户引导**
   - 展示初始化向导
   - 提供模板选择
   - 支持自定义编辑

### 实现步骤
1. [ ] 创建AGENTS.md模板
   - 通用vault模板
   - 常见使用场景模板

2. [ ] 实现检测逻辑
   - onOpen时检查
   - 记录检查状态避免重复

3. [ ] 实现生成逻辑
   - 扫描vault目录结构
   - 分析笔记类型
   - 填充模板

4. [ ] UI交互
   - 初始化对话框
   - 预览和编辑界面
   - 保存确认

## 实现要点

### AGENTS.md通用模板
```markdown
# AGENTS.md

## Vault Overview
This is an Obsidian vault for [描述用途,如:个人知识管理/项目文档/学习笔记].

## Structure
```
vault/
├── Daily Notes/        # 每日笔记
├── Projects/          # 项目管理
├── Resources/         # 资源收集
└── Templates/         # 笔记模板
```

## Conventions

### Naming
- Daily notes: YYYY-MM-DD.md
- Project notes: [Project Name] - [Topic].md
- Reference notes: [Source] - [Title].md

### Linking
- Use [[wiki-links]] for internal links
- Use #tags for categorization
- Use [[MOC]] (Map of Content) for topic overviews

### Metadata
\`\`\`yaml
---
tags: [tag1, tag2]
created: YYYY-MM-DD
updated: YYYY-MM-DD
---
\`\`\`

## AI Assistant Guidelines

When helping with this vault:
1. Maintain consistent formatting and structure
2. Suggest relevant links to existing notes
3. Follow the established naming conventions
4. Preserve metadata in frontmatter
5. Use appropriate tags

## Common Tasks
- Summarize long notes
- Create connections between related notes
- Generate outlines for new topics
- Format and cleanup markdown
- Suggest tags based on content
```

### 检测和初始化流程
```typescript
class OpenCodeView extends ItemView {
  private hasCheckedAgents = false;

  async onOpen(): Promise<void> {
    // ... 现有逻辑
    
    // 检查AGENTS.md
    if (!this.hasCheckedAgents) {
      this.hasCheckedAgents = true;
      await this.checkAndInitializeAgents();
    }
  }

  private async checkAndInitializeAgents(): Promise<void> {
    const agentsFile = this.app.vault.getAbstractFileByPath("AGENTS.md");
    
    if (!agentsFile) {
      // 不存在,显示初始化对话框
      const shouldInit = await this.showAgentsInitDialog();
      if (shouldInit) {
        await this.generateAgentsFile();
      }
    }
  }

  private async showAgentsInitDialog(): Promise<boolean> {
    return new Promise((resolve) => {
      const modal = new AgentsInitModal(this.app, resolve);
      modal.open();
    });
  }

  private async generateAgentsFile(): Promise<void> {
    // 分析vault结构
    const structure = await this.analyzeVaultStructure();
    
    // 生成内容
    const content = this.generateAgentsContent(structure);
    
    // 创建文件
    await this.app.vault.create("AGENTS.md", content);
    
    new Notice("AGENTS.md created successfully");
  }
}
```

### Vault结构分析
```typescript
interface VaultStructure {
  folders: string[];
  fileCount: number;
  hasDaily: boolean;
  hasTemplates: boolean;
  hasMOCs: boolean;
  commonTags: string[];
}

async analyzeVaultStructure(): Promise<VaultStructure> {
  const files = this.app.vault.getMarkdownFiles();
  const folders = new Set<string>();
  const tags = new Map<string, number>();
  
  let hasDaily = false;
  let hasTemplates = false;
  let hasMOCs = false;
  
  for (const file of files) {
    // 文件夹
    const folder = file.parent?.path;
    if (folder) folders.add(folder);
    
    // 检测常见模式
    if (file.path.includes("Daily") || file.path.match(/\d{4}-\d{2}-\d{2}/)) {
      hasDaily = true;
    }
    if (file.path.includes("Template")) {
      hasTemplates = true;
    }
    if (file.basename.includes("MOC")) {
      hasMOCs = true;
    }
    
    // 读取标签
    const cache = this.app.metadataCache.getFileCache(file);
    if (cache?.tags) {
      for (const tag of cache.tags) {
        tags.set(tag.tag, (tags.get(tag.tag) || 0) + 1);
      }
    }
  }
  
  // 获取最常用的标签
  const commonTags = Array.from(tags.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .map(([tag]) => tag);
  
  return {
    folders: Array.from(folders).sort(),
    fileCount: files.length,
    hasDaily,
    hasTemplates,
    hasMOCs,
    commonTags,
  };
}
```

### 初始化对话框
```typescript
class AgentsInitModal extends Modal {
  private onSubmit: (result: boolean) => void;

  constructor(app: App, onSubmit: (result: boolean) => void) {
    super(app);
    this.onSubmit = onSubmit;
  }

  onOpen() {
    const { contentEl } = this;
    
    contentEl.createEl("h2", { text: "Initialize AGENTS.md" });
    
    contentEl.createEl("p", {
      text: "No AGENTS.md file found. Would you like to create one?",
    });
    
    contentEl.createEl("p", {
      text: "AGENTS.md helps the AI assistant understand your vault structure and preferences.",
      cls: "mod-muted",
    });
    
    const buttonDiv = contentEl.createDiv({ cls: "modal-button-container" });
    
    buttonDiv.createEl("button", { text: "Create" })
      .addEventListener("click", () => {
        this.close();
        this.onSubmit(true);
      });
    
    buttonDiv.createEl("button", { text: "Skip" })
      .addEventListener("click", () => {
        this.close();
        this.onSubmit(false);
      });
  }

  onClose() {
    const { contentEl } = this;
    contentEl.empty();
  }
}
```

### 内容生成
```typescript
generateAgentsContent(structure: VaultStructure): string {
  let content = "# AGENTS.md\n\n";
  
  content += "## Vault Overview\n";
  content += `This vault contains ${structure.fileCount} notes.\n\n`;
  
  content += "## Structure\n```\n";
  content += "vault/\n";
  for (const folder of structure.folders.slice(0, 10)) {
    content += `├── ${folder}/\n`;
  }
  content += "```\n\n";
  
  if (structure.commonTags.length > 0) {
    content += "## Common Tags\n";
    for (const tag of structure.commonTags) {
      content += `- ${tag}\n`;
    }
    content += "\n";
  }
  
  content += "## AI Assistant Guidelines\n\n";
  content += "When helping with this vault:\n";
  content += "1. Maintain consistent formatting\n";
  content += "2. Suggest relevant links to existing notes\n";
  content += "3. Use appropriate tags based on content\n\n";
  
  return content;
}
```

## 问题与解决

### 问题1: 首次检查时机
- **问题**: 何时显示初始化对话框
- **解决**: 
  - 在视图onOpen时检查
  - 使用flag避免重复检查
  - 可在设置中重新触发

### 问题2: 模板个性化程度
- **问题**: 自动生成vs用户自定义的平衡
- **解决**: 
  - 提供基础模板
  - 包含vault结构分析结果
  - 用户可随时编辑

### 问题3: 性能影响
- **问题**: 分析大型vault可能很慢
- **解决**: 
  - 异步执行
  - 限制分析深度
  - 显示进度提示

### 问题4: 与现有AGENTS.md冲突
- **问题**: 用户可能手动创建了AGENTS.md
- **解决**: 
  - 只在不存在时创建
  - 提供"重新生成"选项
  - 保留备份

## 复盘

**待实施后填写**

## 后续

1. 参考opencode-obsidian-main的AGENTS.md
2. 设计更好的模板
3. 实现vault结构分析
4. 添加多个模板选项(学习/工作/写作等)
5. 提供模板库供用户选择

